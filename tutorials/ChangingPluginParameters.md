# Overview #

The RobotX-specific behavior of the models and the environment is generated by a set of [Gazebo Model Plugins](http://gazebosim.org/tutorials?tut=plugins_hello_world).  The current models used in these plugins are described in [the Documentation Wiki: Gazebo Plugins](https://bitbucket.org/osrf/vrx/wiki/VRXGazeboPlugins).  The parameters of the associated models (USV drag coefficient, wind speed, etc.) can be changed through the use of SDF configuration files.

This tutorial briefly describes where the base parameter files that are included with this repository are stored so that users can change the parameters to test their solutions under a variety of conditions.

| Description | File Location | Notes |
|-------------|---------------|------ |
| Hydrodynamic parameters (drag, added mass, etc.) | wamv_gazebo/urdf/dynamics/wamv_gazebo_dynamics_plugin.xacro | Current parameters based on FAU Publication https://doi.org/10.1016/j.oceaneng.2016.09.037 |
| Wave characteristics (peak period, gain, direction, etc.) | wave_gazebo/world_models/ocean_waves/model.xacro | See current version of the [VRX Technical Guide](https://bitbucket.org/osrf/vrx/wiki/documentation) for the envelope of values which used in the VRX challenge. |
| Propulsion characteristics (linear or nonlinear mapping and force limits) | wamv_gazebo/urdf/thruster_layouts/wamv_gazebo_thruster_config.xacro | Nonlinear mapping is based on experimental results from FAU https://doi.org/10.1016/j.oceaneng.2016.09.037 |
| Wind velocity and windage coefficients | vrx_gazebo/worlds/sandisland.world.xacro and vrx_gazebo/worlds/xacros/usv_wind_plugin.xacro | Windage coefficeints from same FAU report https://doi.org/10.1016/j.oceaneng.2016.09.037 |



# Example: Changing the Wind #
As an illustrative example, we'll go through testing our simulation with different wind conditions.  

 * The default wind parameters (speed, variability, direction, etc.) are defined in the [vrx_gazebo/worlds/xacros/usv_wind_plugin.xacro]/xacros/(https://bitbucket.org/osrf/vrx/src/default/vrx_gazebo/worlds/xacros/usv_wind_plugin.xacro) file.  The file defines an XML macro that is then used when defining Gazebo worlds to specify use of the usv_wind_plugin.  Changing parameters in this file will change the default wind conditions for the simulation.
 * The models affected by the wind and how they are affected is defined in the specific world file.  For example, the [vrx_gazebo/worlds/sandisland.world.xacro](https://bitbucket.org/osrf/vrx/src/default/vrx_gazebo/worlds/sandisland.world.xacro) file calls the usv_wind_gazebo macro defined in the usv_wind_plugin.xacro file and specifies that the wind forces should be applied to the `wamv` model with specific wind coefficients. If you view the sandisland.world.xacro file you will see lines like this...

```
<xacro:include filename="$(find vrx_gazebo)/worlds/xacros/gazebo_wind_plugin.xacro"/>
<xacro:usv_wind_gazebo>
  <wind_objs>
    <wind_obj>         
      <name>wamv</name>
      <link_name>base_link</link_name>
      <coeff_vector>0.5 0.5 0.33</coeff_vector>
    </wind_obj>
  </wind_objs>
</xacro:usv_wind_gazebo>
```
Any number of wind_obj's may be added under wind_objs. Only one link per model is supported.

To change the wind plugin parameters we can do a combination of the following:

 * Change the default wind parameters [vrx_gazebo/worlds/xacros/usv_wind_plugin.xacro](https://bitbucket.org/osrf/vrx/src/default/vrx_gazebo/worlds/xacros/usv_wind_plugin.xacro)
 * Override the default parameters when calling the macro in the [vrx_gazebo/worlds/sandisland.world.xacro](https://bitbucket.org/osrf/vrx/src/default/vrx_gazebo/worlds/sandisland.world.xacro) file.
 * Change the models affected by wind or their coefficients in [vrx_gazebo/worlds/sandisland.world.xacro](https://bitbucket.org/osrf/vrx/src/default/vrx_gazebo/worlds/sandisland.world.xacro).
 * Note: Make sure to run `catkin_make` after any changes to process the XML macros.

For development purposes, the instantaneous wind speed is published as a ROS message.  After starting the simulation (`roslaunch vrx_gazebo sandisland.launch`) the wind velocity can be published using rqt_topic (`rqt_plot /vrx/debug/wind/speed/data').  Below are some examples to illustrate how the wind parameters affect the time history:

## 
| Wind Parameters | Time History |
|-----------------|--------------|
| mean_vel = 8; var_gain = 0; var_time = 1 | ![Screenshot from 2019-07-02 13-25-52.png](https://bitbucket.org/repo/BgXLzgM/images/4044523634-Screenshot%20from%202019-07-02%2013-25-52.png) |
| mean_vel = 0; var_gain = 8; var_time = 1 | ![Screenshot from 2019-07-02 13-29-55.png](https://bitbucket.org/repo/BgXLzgM/images/1790020888-Screenshot%20from%202019-07-02%2013-29-55.png) |
| mean_vel = 0; var_gain = 8; var_time = 10 | ![Screenshot from 2019-07-02 13-32-09.png](https://bitbucket.org/repo/BgXLzgM/images/2800119210-Screenshot%20from%202019-07-02%2013-32-09.png) |
| mean_vel = 8; var_gain = 8; var_time = 1 | ![Screenshot from 2019-07-02 13-34-08.png](https://bitbucket.org/repo/BgXLzgM/images/1533815556-Screenshot%20from%202019-07-02%2013-34-08.png) |

NOTE: For another example, see vrx_gazebo/worlds/wind_test.world.xacro

# Example: Changing the Wave Field #

As an illustrative example, we'll go through testing the simulation with different wave scenarios.  The wave field characteristics are defined in the `wave_gazebo/world_models/ocean_waves/model.xacro` file.  When we open the file we see a section that looks like this...

```
 <xacro:macro name="ocean_waves" params="gain:=0.1 period:=5
                     direction_x:=1.0 direction_y:=0.0
                     angle:=0.4">
```

This specifies the `ocean_waves` macro with five optional input parameters.  This macro is used to add the ocean model to world descriptions within the VRX simulation.  For example, the `vrx_gazebo/worlds/example_course.world.xacro` file contains this snippet

```
    <!--Waves-->
    <xacro:include filename="$(find wave_gazebo)/world_models/ocean_waves/model.xacro"/>
    <xacro:ocean_waves/>
```

which calls the `ocean_waves` macro with using the default input parameters. 

Consider the case where we are testing a new algorithm and want to start with a flat ocean (no waves) before adding wave induced motion.  We could accomplish this a few different ways.

**Option 1: Change global default parameters.** One option is to change the default wave parameter values.  Edit the `wave_gazebo/world_models/ocean_waves/model.xacro` file, changing the gain value to zero, so it looks like this.  
```
 <xacro:macro name="ocean_waves" params="gain:=0.0 period:=5
                     direction_x:=1.0 direction_y:=0.0
                     angle:=0.4">
```
Now, for any world that uses the macro without explicitly setting the gain parameter, the value will be zero so all the wave amplitudes will be zero - a flat ocean.  Note, you will need to run `catkin_make` so that the changes take effect. 

**Option 2: Change local parameters.**  A second option is to explicitly set the parameters when calling the macro.  For example, edit the `vrx_gazebo/worlds/example_course.world.xacro` to set the gain parameter to zero when calling the macro like so...
```
  <!--Waves-->
    <xacro:include filename="$(find wave_gazebo)/world_models/ocean_waves/model.xacro"/>
    <xacro:ocean_waves gain="0.0"/>
```
Then execute `catkin_make` and when you run `roslaunch vrx_gazebo vrx.launch` (which uses the example_course world) the ocean waves will all have zero amplitude. 

After testing in zero seastate, we may want to stress our algorithm by increasing the seastate.  This can be accomplished by increasing the gain and/or peak period of the wave spectrum.  It might also be important to test with different wave directions to make sure that a particular solution isn't dependent on a particular wave direction.  Ideally, solutions would be tested over the range of possible seastate parameters - see current version of the [VRX Technical Guide](https://bitbucket.org/osrf/vrx/wiki/documentation) for the envelope of values which used in the VRX challenge.

We've posted a [video](https://vimeo.com/257586610) showing how we would test with three different seastates - including how to break a buoy!